name: Update Notion Changelog with AI

on:
  push:
    branches:
      - main # Change this if your default branch is 'master'

jobs:
  update-notion-page:
    runs-on: ubuntu-latest
    steps:
      - name: Send Commit Data and AI Summary to Notion
        uses: actions/github-script@v6
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_PAGE_ID: ${{ secrets.NOTION_PAGE_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const commitMsg = context.payload.head_commit.message;
            const commitUrl = context.payload.head_commit.url;
            const author = context.payload.head_commit.author.name;
            const commitSha = context.payload.head_commit.id;

            console.log("Fetching code changes...");
            const { data: commit } = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: commitSha
            });
            
            let diffText = "";
            if (commit.files) {
              commit.files.forEach(file => {
                diffText += `File: ${file.filename}\nChanges:\n${file.patch}\n\n`;
              });
            }
            
            // Limit text size to keep it safe
            diffText = diffText.substring(0, 15000);

            console.log("Asking AI to summarize...");
            const prompt = `You are a game developer writing patch notes for non-technical players. Summarize these raw code changes into 1 to 3 short, fun, simple sentences. Focus only on what changed for the player. DO NOT use markdown like asterisks or bolding. Use standard text. Code:\n\n${diffText}`;
            
            const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${process.env.GEMINI_API_KEY}`;
            
            // TURN OFF SAFETY FILTERS FOR HACKER WORDS
            const requestBody = {
              contents: [{ parts: [{ text: prompt }] }],
              safetySettings: [
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" }
              ]
            };

            const aiResponse = await fetch(geminiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestBody)
            });
            
            const aiData = await aiResponse.json();
            let aiSummary = "AI could not generate summary.";
            
            // Smarter Error Checking
            if (aiData.error) {
                console.error("Gemini API Error:", aiData.error);
                aiSummary = "API Error. Check GitHub Actions Logs.";
            } else if (aiData.candidates && aiData.candidates[0].content) {
              aiSummary = aiData.candidates[0].content.parts[0].text.trim();
            } else if (aiData.candidates && aiData.candidates[0].finishReason) {
                console.warn("Blocked by safety filters:", aiData.candidates[0].finishReason);
                aiSummary = "Blocked by AI safety filters (Too many hacker words!).";
            }

            console.log("Sending to Notion...");
            const response = await fetch(`https://api.notion.com/v1/blocks/${process.env.NOTION_PAGE_ID}/children`, {
              method: 'PATCH',
              headers: {
                'Authorization': `Bearer ${process.env.NOTION_TOKEN}`,
                'Content-Type': 'application/json',
                'Notion-Version': '2022-06-28'
              },
              body: JSON.stringify({
                children: [
                  {
                    object: 'block',
                    type: 'bulleted_list_item',
                    bulleted_list_item: {
                      rich_text: [
                        { type: 'text', text: { content: `ðŸ“¦ Push by ${author}: ${commitMsg} (` } },
                        { type: 'text', text: { content: "View Code", link: { url: commitUrl } } },
                        { type: 'text', text: { content: ")" } }
                      ],
                      children: [
                        {
                          object: 'block',
                          type: 'quote',
                          quote: {
                            rich_text: [
                              { type: 'text', text: { content: `ðŸ¤– AI Patch Notes:\n${aiSummary}` } }
                            ]
                          }
                        }
                      ]
                    }
                  }
                ]
              })
            });
            
            if (!response.ok) {
              const err = await response.text();
              console.error("Notion API Error:", err);
              throw new Error("Failed to update Notion");
            }
            console.log("Successfully updated Notion with AI summary!");
