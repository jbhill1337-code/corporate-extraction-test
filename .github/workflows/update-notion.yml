name: Update Notion Changelog

on:
  push:
    branches:
      - main # Change this if your default branch is 'master'

jobs:
  update-notion-page:
    runs-on: ubuntu-latest
    steps:
      - name: Send Commit Data to Notion
        uses: actions/github-script@v6
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_PAGE_ID: ${{ secrets.NOTION_PAGE_ID }}
        with:
          script: |
            const commitMsg = context.payload.head_commit.message;
            const commitUrl = context.payload.head_commit.url;
            const author = context.payload.head_commit.author.name;
            
            // Send the API request to Notion
            const response = await fetch(`https://api.notion.com/v1/blocks/${process.env.NOTION_PAGE_ID}/children`, {
              method: 'PATCH',
              headers: {
                'Authorization': `Bearer ${process.env.NOTION_TOKEN}`,
                'Content-Type': 'application/json',
                'Notion-Version': '2022-06-28'
              },
              body: JSON.stringify({
                children: [
                  {
                    object: 'block',
                    type: 'bulleted_list_item',
                    bulleted_list_item: {
                      rich_text: [
                        { type: 'text', text: { content: `ðŸ“¦ Push by ${author}: ${commitMsg} (` } },
                        { type: 'text', text: { content: "View Code", link: { url: commitUrl } } },
                        { type: 'text', text: { content: ")" } }
                      ]
                    }
                  }
                ]
              })
            });
            
            if (!response.ok) {
              const err = await response.text();
              console.error("Notion API Error:", err);
              throw new Error("Failed to update Notion");
            }
            console.log("Successfully updated Notion!");
